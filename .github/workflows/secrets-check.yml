name: Secret Detection

on:
  pull_request:
    branches: [main]

jobs:
  detect-secrets:
    name: Detect Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect hardcoded secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for common secret patterns
        run: |
          echo "Checking for common secret patterns..."

          # Check for hardcoded API keys (common patterns)
          if grep -rE "(sk-[a-zA-Z0-9]{20,}|AKIA[A-Z0-9]{16})" --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v ".env.example"; then
            echo "::error::Potential hardcoded API keys detected!"
            exit 1
          fi

          # Check for hardcoded MongoDB URIs with credentials
          if grep -rE "mongodb\+srv://[^:]+:[^@]+@" --include="*.py" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v ".env.example"; then
            echo "::error::Potential hardcoded MongoDB URI detected!"
            exit 1
          fi

          # Check for is_production=True hardcoded
          if grep -rE "is_production\s*=\s*True" --include="*.py" .; then
            echo "::error::Hardcoded is_production=True detected! Use config.settings.is_production instead."
            exit 1
          fi

          echo "âœ… No hardcoded secrets detected"
